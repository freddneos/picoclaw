services:
  # ─────────────────────────────────────────────
  # PicoClaw Agent (one-shot query)
  #   docker compose run --rm picoclaw-agent -m "Hello"
  # ─────────────────────────────────────────────
  picoclaw-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: picoclaw-agent
    profiles:
      - agent
    volumes:
      - ./config/config.json:/home/picoclaw/.picoclaw/config.json:ro
      - picoclaw-workspace:/home/picoclaw/.picoclaw/workspace
    entrypoint: ["picoclaw", "agent"]
    stdin_open: true
    tty: true

  # ─────────────────────────────────────────────
  # PicoClaw Gateway (Long-running Bot)
  #   Runs automatically with 'docker compose up'
  # ─────────────────────────────────────────────
  picoclaw-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: picoclaw-gateway
    restart: unless-stopped
    volumes:
      # Configuration file (shared with webui)
      - ./config/config.json:/home/picoclaw/.picoclaw/config.json
      # Persistent workspace (sessions, memory, logs)
      - picoclaw-workspace:/home/picoclaw/.picoclaw/workspace
    command: ["gateway"]
    healthcheck:
      test: ["CMD", "pgrep", "-f", "picoclaw"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ─────────────────────────────────────────────
  # PicoClaw Web UI (Configuration + Chat Interface)
  #   Accessible at http://localhost:8080
  # ─────────────────────────────────────────────
  picoclaw-webui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: picoclaw-webui
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      # Configuration file (read-write for editing)
      - ./config/config.json:/home/picoclaw/.picoclaw/config.json
      # Persistent workspace (shared with gateway)
      - picoclaw-workspace:/home/picoclaw/.picoclaw/workspace
    command: ["webui", "--host", "0.0.0.0", "--port", "8080"]
    depends_on:
      picoclaw-gateway:
        condition: service_healthy

volumes:
  picoclaw-workspace:
