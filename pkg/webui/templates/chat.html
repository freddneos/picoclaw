{{define "chat-content"}}
<div class="header">
    <h1>üí¨ Test Chat Interface</h1>
    <p style="color: #7f8c8d; margin-top: 5px;">Chat directly with the bot to test different identities and behaviors</p>
    <p style="color: #3498db; margin-top: 10px; font-size: 14px;">
        üí° <strong>Testing Tip:</strong> Use this to verify your active bot identity responds correctly. Switch identities in the <a href="/identities" style="color: #3498db;">Bot Identities</a> page and chat here to see the personality change.
    </p>
</div>

<div class="card" style="max-width: 900px; margin: 0 auto;">
    <!-- Main Chat Area -->
    <div style="display: flex; flex-direction: column; height: calc(100vh - 280px);">
        <div style="border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-bottom: 15px;">
            <h2 id="chat-title">Web UI Test Chat</h2>
            <p id="chat-subtitle" style="color: #95a5a6; font-size: 12px; margin-top: 5px;">Direct conversation with the active bot identity</p>
        </div>

        <!-- Messages Area -->
        <div id="messages-area" style="flex: 1; overflow-y: auto; padding: 15px; background: #f5f7fa; border-radius: 4px; margin-bottom: 15px;">
            <div id="messages-container">
                <div class="message received">
                    <div class="message-bubble">
                        üëã Hello! I'm ready to chat. Try asking me something to test the current bot identity.
                    </div>
                    <div class="message-time">Just now</div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text"
                   id="message-input"
                   placeholder="Type your message..."
                   style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px;"
                   onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }">
            <button class="btn btn-secondary" onclick="clearChat()" style="padding: 12px 20px;">
                üóëÔ∏è Clear
            </button>
            <button class="btn btn-primary" onclick="sendMessage()" style="padding: 12px 24px;" id="send-btn">
                Send
            </button>
        </div>
    </div>
</div>

<style>
    .message {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
    }

    .message.sent {
        align-items: flex-end;
    }

    .message.received {
        align-items: flex-start;
    }

    .message-bubble {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 12px;
        word-wrap: break-word;
    }

    .message.sent .message-bubble {
        background: #3498db;
        color: white;
    }

    .message.received .message-bubble {
        background: white;
        color: #2c3e50;
        border: 1px solid #ecf0f1;
    }

    .message-time {
        font-size: 11px;
        color: #95a5a6;
        margin-top: 5px;
    }

    .conversation-item {
        padding: 12px;
        border-bottom: 1px solid #ecf0f1;
        cursor: pointer;
        transition: background 0.2s;
    }

    .conversation-item:hover {
        background: #f5f7fa;
    }

    .conversation-item.active {
        background: #e8f4f8;
        border-left: 3px solid #3498db;
    }

    .conversation-name {
        font-weight: 600;
        margin-bottom: 4px;
    }

    .conversation-preview {
        font-size: 12px;
        color: #95a5a6;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>

<script>
    let conversationHistory = [];

    function addUserMessage(text) {
        const container = document.getElementById('messages-container');
        const messageEl = document.createElement('div');
        messageEl.className = 'message sent';
        messageEl.innerHTML = `
            <div class="message-bubble">
                ${escapeHtml(text)}
            </div>
            <div class="message-time">${new Date().toLocaleTimeString()}</div>
        `;
        container.appendChild(messageEl);
        scrollToBottom();
    }

    function addBotMessage(text, thinking = false) {
        const container = document.getElementById('messages-container');
        const messageEl = document.createElement('div');
        messageEl.className = 'message received';
        messageEl.id = thinking ? 'thinking-message' : '';
        messageEl.innerHTML = `
            <div class="message-bubble">
                ${thinking ? 'üí≠ ' : ''}${escapeHtml(text)}
            </div>
            <div class="message-time">${new Date().toLocaleTimeString()}</div>
        `;
        container.appendChild(messageEl);
        scrollToBottom();
        return messageEl;
    }

    async function sendMessage() {
        const input = document.getElementById('message-input');
        const text = input.value.trim();

        if (!text) {
            return;
        }

        // Disable input while processing
        input.disabled = true;
        document.getElementById('send-btn').disabled = true;

        // Add user message
        addUserMessage(text);
        input.value = '';

        // Add thinking indicator
        const thinkingMsg = addBotMessage('Thinking...', true);

        try {
            const result = await apiCall('/api/chat/send', {
                message: text,
                history: conversationHistory
            });

            // Remove thinking indicator
            thinkingMsg.remove();

            if (result.status === 'ok' && result.response) {
                addBotMessage(result.response);
                conversationHistory.push({ role: 'user', content: text });
                conversationHistory.push({ role: 'assistant', content: result.response });

                // Keep only last 10 messages to avoid context overflow
                if (conversationHistory.length > 20) {
                    conversationHistory = conversationHistory.slice(-20);
                }
            } else {
                addBotMessage('Sorry, I encountered an error: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            thinkingMsg.remove();
            addBotMessage('Error: ' + error.message);
            showToast('Failed to send message: ' + error.message, 'error');
        } finally {
            // Re-enable input
            input.disabled = false;
            document.getElementById('send-btn').disabled = false;
            input.focus();
        }
    }

    function clearChat() {
        if (confirm('Clear all messages?')) {
            conversationHistory = [];
            const container = document.getElementById('messages-container');
            container.innerHTML = `
                <div class="message received">
                    <div class="message-bubble">
                        üëã Hello! I'm ready to chat. Try asking me something to test the current bot identity.
                    </div>
                    <div class="message-time">Just now</div>
                </div>
            `;
            showToast('Chat cleared', 'success');
        }
    }

    function scrollToBottom() {
        const messagesArea = document.getElementById('messages-area');
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Focus input on load
    document.getElementById('message-input').focus();
</script>
{{end}}
